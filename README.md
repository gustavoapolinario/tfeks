## Overview

This repository provides a Terraform configuration to deploy and manage an Amazon EKS (Elastic Kubernetes Service) cluster on AWS. It leverages modular Terraform code to provision networking, IAM roles, storage, RBAC, and various EKS add-ons, enabling a production-ready Kubernetes environment.

## Architecture

The project is organized into reusable modules located in the `modules/` directory. Each module encapsulates specific infrastructure components or operational features for the EKS cluster.

### Main Modules

- **eks**: Provisions the core EKS cluster, including control plane, node groups, Fargate profiles, and cluster-level IAM roles.
- **vpc**: Creates the Virtual Private Cloud, subnets, NAT gateways, and related networking resources required for EKS.
- **eks-ebs-csi-driver**: Deploys the AWS EBS CSI driver for dynamic storage provisioning in Kubernetes.
- **eks-external-secrets**: Integrates Kubernetes with AWS Secrets Manager and Parameter Store, enabling secure secret management.
- **eks-load-balancer-controller**: Installs the AWS Load Balancer Controller for managing AWS ALBs and NLBs via Kubernetes resources.
- **eks-rbac-default-roles**: Sets up default RBAC roles for Kubernetes users and groups.
- **terraform-state-management**: (If present) Manages S3 and DynamoDB resources for storing and locking Terraform state files.

## Usage

### Prepare your project

This command will install the providers needed for the project

```
terraform init
```

### Create the tfvars file

Rename the terraform.tfvars.example file to terraform.tfvars. It has the a sample to use the project

```
mv terraform.tfvars.example terraform.tfvars
```

### Creating the storage for tfstate and lock

To work as a team, and to the CI/CD is important to save the tfstate file of each environment

To work with the team, is important create a lock beatween everyone to noone run as same time the cloudformation, but create a pipeline is the best option

To save the state on S3 and use the dynamodb as lock, see the file tf-backend.tf and tf-backend-outputs.tf

Edit the tf-backend.tf with your informations. See the information of module: [cloudposse/tfstate-backend](https://registry.terraform.io/modules/cloudposse/tfstate-backend/aws/latest)

```
code tf-backend.tf
```

Run the apply for this resource to create the TF backend file

```
terraform apply -target=module.terraform_state_backend
```

After runned it, verify your backend.tf file

```
cat backend.tf
```

After verify the configuration generated by the module, run the init again to load the configuration

```
terraform init -force-copy
```

### Create the EKS
```
terraform plan
terraform apply
```

## Documentation

- Each module contains its own `README.md` with details about inputs, outputs, and resources.
- See the [docs/index.md](docs/index.md) for an overview and links to module documentation.

## Modules Directory

- [modules/eks](modules/eks/README.md): EKS cluster provisioning.
- [modules/vpc](modules/vpc/README.md): VPC and networking.
- [modules/eks-ebs-csi-driver](modules/eks-ebs-csi-driver/README.md): EBS CSI driver.
- [modules/eks-external-secrets](modules/eks-external-secrets/README.md): External Secrets integration.
- [modules/eks-load-balancer-controller](modules/eks-load-balancer-controller/README.md): Load Balancer Controller.
- [modules/eks-rbac-default-roles](modules/eks-rbac-default-roles/README.md): Default RBAC roles.

Go on each module's documentation to his specific configuration options and outputs.
